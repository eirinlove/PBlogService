<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <link rel = "stylesheet" type="text/css" href= "/public/css/thread_view.css">
    <link rel = "stylesheet" type="text/css" href= "/public/css/register.css">
    <script type="text/JavaScript" src="/function/mailpass.js" ></script>
    

    <title>회원가입</title>



  </head>
  <body>
    <%- include('nav.ejs') %>
    <div class ="article_area">
    <div class ="register_id_boxform">
        <div class = "register_id_inputbox">
        <div class = "input_text_box"><span class="register_title">메일주소</span>
            <input type = "text" class = "box_context mailbox"> <button class = "mail_check">인증요청</button>
                <input type = "text" class = "mail_number_box"> <button class = "mail_check_object">인증확인</button></div>
       
        <div class = "input_text_box"><span class="register_title">아이디</span>
            <input type = "text" class = "box_context idbox">
            <button class = "id_check">중복확인</button> </div>
        
        <div class = "input_text_box" ><span class="register_title">비밀번호</span>
            <input type = "password" class = "box_context passbox"><span class ="hiddenpwd"></span></div>
        <div class = "input_text_box"><span class="register_title">닉네임</span>
            <input type = "text" class = "box_context nnamebox"> </div>
            <div class = "float_right"><button class = "register_ok">가입</button></div>
          </div>
        
    </div>
    </div>





    <script>
        var authcodes;
        var idcodes;
        var mail_check = false;
        var id_check = false;


        $('.mail_check').click(function(e){ //jquery로 가져옴.클릭함수를.
            
            let data = $('.mailbox').val();
            
            
            $.ajax({
            method : 'POST',
            url : '/accountfunc/emailcheck',
            data : { mail : data } // 123을 /delete 경로로 보낸다. , req.body로 받는다. , 즉 위의 postoren이 server.js의 req.body._id가 됨.
            // _id_a 는 오브젝트id 

          }).done(function(rep){ // 성공의 경우. 
          
           alert(rep.result);
           authcodes = rep.authbutton;
            //alert(JSON.stringify(rep.authcode));
            //alert(rep.authbutton);

          }).fail(function(xhr, textStatus, errorThrown){ //실패시,
            alert('메일을 보내지못했습니다. 다시 시도하세요.');
            console.log(xhr, textStatus, errorThrown);
          });

        });


        $('.mail_check_object').click(function(e){ //jquery로 가져옴.클릭함수를.
          
          let mailAuthData = $('.mail_number_box').val();
         
          if (authcodes == mailAuthData){

            alert ("메일인증이 완료되었습니다.");
            mail_check = true;
            
          }

          else if(!authcodes){

            alert ("메일인증이 필요합니다.");
          }

          else {
            alert ("인증번호가 불일치합니다.")
          }
        });


        $('.id_check').click(function(e){ 
            
            let data = $('.idbox').val();
            
            
            $.ajax({
            method : 'POST',
            url : '/accountfunc/idcheck',
            data : { usrid : data } // 123을 /delete 경로로 보낸다. , req.body로 받는다. , 즉 위의 postoren이 server.js의 req.body._id가 됨.
            // _id_a 는 오브젝트id 

          }).done(function(rep){ // 성공의 경우. 
          
            
            alert(rep.result);
           
            id_check = rep.dupcheck;

            

          }).fail(function(xhr, textStatus, errorThrown){ //실패시,
            alert('다시 입력하십시요');
            console.log(xhr, textStatus, errorThrown);
          });

        });
      

      
        var oldVal;
        var passvalid = false;
        //function passcheck(){
          $('.passbox').on("propertychange change keyup paste input", function(){
          var passwords = $('.passbox').val();
          var currentVal = $(this).val();
          if (currentVal == oldVal){
            return;

          }
          oldVal = currentVal;
          //alert('바뀜');
          var passwordRule = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
          if(passwordRule.test(passwords))
          {
            //alert('하이2');
            $('.passbox').css('border', '1px green solid');
            $('.hiddenpwd').text("사용가능한 패스워드입니다.");
            $('.hiddenpwd').css('color','#44da31' );
            passvalid = true;
          }
          else{
            $('.passbox').css('border', '1px #d33636 solid');
            $('.hiddenpwd').text("비밀번호는 8자리 이상의 숫자+문자 조합이어야 합니다.");
            $('.hiddenpwd').css('font-size','15px' );
            $('.hiddenpwd').css('margin-left','30px' );
            $('.hiddenpwd').css('color','red' );
            //alert('하이1');
            passvalid = false;
          }
         
        });
        



        $('.register_ok').click(function(e){

          var register_check = false;
          var nname = $('.nnamebox').val();
          if (mail_check == false) {

            alert ('메일 인증을 진행 해 주세요.');
          }

          if (id_check == false) {

            alert ('아이디 중복검사를 진행 해 주세요.');
          }

          if (passvalid == false){

            alert ('패스워드를 확인하세요');
          }

          if (!nname){

            alert ('닉네임을 확인하세요');
          }

          if (mail_check == true && id_check == true && passvalid == true && nname){
            
            var sendMail = $('.mailbox').val();
            var sendId = $('.idbox').val();
            var sendPass = $('.passbox').val();
            var sendNname = $('.nnamebox').val();
            $.ajax({
              method : 'POST',
              url : '/accountfunc/register',
              data : {receiveMail : sendMail,
                      receiveId : sendId,
                      receivePass : sendPass,
                      receiveNname : sendNname}

            }).done(function(rep){

              alert (rep.result);
              if(rep.valid = true){

                location.replace('./thread/thread_list');
              }
            })

          }
          })
        </script>







    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js" integrity="sha384-eMNCOe7tC1doHpGoWe/6oMVemdAVTMs2xqW4mwXrXsW0L84Iytr2wi5v2QjrP/xp" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js" integrity="sha384-cn7l7gDp0eyniUwwAZgrzD06kc/tftFf19TOAs2zVinnD/C7E91j9yyk5//jjpt/" crossorigin="anonymous"></script>
    
  </body>
</html>